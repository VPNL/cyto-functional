Notes on how to register ROIs from the surface mesh MRI of post-mortem to their 3D histological reconstuctions

To start, you must have the MPM fROIs registered to each postmortem subjects' cortical surface.
To do this you run 2 steps:
  1. register the MPM fROI regions to an individual subject
    mri_label2label --srcsubject <fsaverage> --srclabel <MPM fROI label> --trgsubject <target PM subject> --trglabel <MPM fROI_pm label> -- regmethod surface --hemi <hemisphere> 
  2. Create a nifti volume from the registered MPM label
    mri_label2vol --label <MPM fROI label> --temp <orig.mgz> --identity --proj frac <0 1 .1> --subject <PM subject> --o <MPM_fROI.nii.gz>

STEP 1: afniCreateAffine.m 
Next is the rough alignment from the MRI anatomical image to the histological reconstuction of the same pm subject.
Use the function afniCreateAffine.m to generate the tranformation matrix that will be applies to the fROIs.
  code basics:
  sets up afni
  source /etc/afni/afni.sh
  
  Use 3dAllineate to do a linear (12DoF) registration from the mri volume anatomy of a PM subject to the 3D histological reconstuction of the same subject. 
  This step creates fewer distortions in the final registration than if you were to run ANTs on a untranformed volume. 
  This registration creates an output transform file called .param.1D That will be applied to the fROIS in the function anfiApplyAffine.m

  core function:
    3dAllineate -prefix afni_result.nii.gz -base pm1_historecon.nii.gz -input pm1_mri_anat.nii.gz -cmass -twopass -1Dparam_save afni_param

Step 2: afniCreateAffine.m
This applies the .param.1D registration file to the a ROI to register it to the histological reconstruction.

  code basics: 
  sets up afni
  source /etc/afni/afni.sh
  
  Use 3dAllineate with the -1Dparam_apply flag to skip calculating the transformation and apply what we save out in the last step.
  
  core function:
    3dAllineate -prefix rh_MPM_PPA_3dAllineate.nii.gz -base pm1_historecon.nii.gz -input rh.MPM_PPA_pm1.nii.gz -1Dparam_apply afni_param.param.1D

Step 3: antsCreateWarp
The purpose of this step is to use a nonlinear tranformation to align the cortical folding across the two brains. We need this step because the histological 3D reconstructed volume is distorted relative to the 3D MRI volume. 

Running the non-linear alignment between the output of 3dAllineate and the 3D histological volume reconstruction using the afni function 3dQwarp. 

This alignment generates an output volume which we called afni_result_qwarp.nii.gz  and a registration file called afni_result_qwarp_WARP.nii.gz.

3dQwarp -prefix afni_result_qwarp.nii.gz  -source afni_result.nii.gz -base pm14686histo_invNlin_corr_small_histcorr_pad.nii.gz 

Step 4. 
Apply the non-linear transform calculated in step 3 to the ROIs.
3dNwarpApply -nwarp afni_result_qwarp_WARP.nii.gz -source niftiROIs/rh_MPM_pFus_afni.nii.gz -prefix rh_MPM_pFus_anfi_3dQwarp.nii.gz

References:  https://afni.nimh.nih.gov/pub/dist/doc/program_help/3dAllineate.html
https://afni.nimh.nih.gov/pub/dist/doc/program_help/3dWarp.html
